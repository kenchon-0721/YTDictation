# 利用手順

## 1. Node.js と npm のインストール
https://nodejs.org からインストーラをダウンロードして言われるがままにインストールの作業を進める。このとき同時に npm とうのコマンドも使えるようになる。

## 2. 環境構築
このデポジトリを保存したフォルダ (app.js とかがあるところ) まで移動し、ターミナルで
```
npm init -y
```
を実行。

続いて、同じフォルダを開いたままにして
```
npm install express --save
```
を実行。

## 3. ローカルサーバーの構築
ターミナルにて
```
node app.js
```
を実行することにより、httpプロトコルでファイルにアクセスできるようになる。<br>
ブラウザで
```http://localhost:8080/front.html``` 
にアクセスすれば htmlファイルが開く。

なお、サーバーを落としたい場合は、単に ```Ctrl + C``` などでプロセスを中断すればOK。

* ポート番号はデフォルトで 8080 であるが、変更したい場合は```./main/scripts/init.js``` の1行目の ```PORT_NUMBER``` と  ```./config.js``` の ```port``` の2つの値を希望するポート番号に変更する。
<br><br>


# リファレンス (中身をいじる人向け)

```./main/scripts/front.js``` から、プレーヤーを操作したり、字幕を取得することが出来る。

**プレイヤーや字幕に関する記述は、動画及び字幕の取得が完了した際に実行される、 ```./main/scripts/front.js``` 内の ```onCaptionReady```
関数内に記述するのが望ましい。**

以下では主要な関数を羅列するが、その他の操作を行いたい場合は [YouTube IFrame Player API のページ](https://developers.google.com/youtube/iframe_api_reference?hl=ja#Playback_status) を参照。

## 1. プレイヤーの操作・値の取得
### 動画の再生: ```player.playVideo()```
動画は頭出しされた状態でロードされ、自動的には再生開始されないので、自動で再生を開始するにはこのコマンドを実行する。<br><br>

### 動画の一時停止: ```player.pauseVideo()```
現在の位置で動画を一時停止する。<br><br>


### 指定した時間に移動: ```player.seekTo(seconds:Number, ```
### ```allowSeekAhead: Boolean)```
```seconds``` は飛びたい時間の動画開始からの秒数 (小数)、```allowSeekAhead``` は、 ```false``` に設定すると、まだ読み込まれていないところ (プレイヤーの時間バーで白くなっていないところ) は読み込まれないので、基本は ```true``` にしとけばOK。以下、YouTube API のサイトから引用。

>動画を指定された時間シークします。この関数を呼び出したときにプレーヤーが一時停止している場合は一時停止のままになり、その他の状態（```playing```: 再生中、```video cued```: 頭出し完了・未再生 など）から呼び出した場合は、動画が再生されます。
```seconds``` パラメータには、プレーヤーを進ませる秒数を指定します。<br><br>
> * ユーザーがシークしている部分がダウンロード済みでなければ、このパラメータで指定した時間の前の最も近いキーフレームまで進みます。シークしている部分をダウンロード済みの場合、プレーヤーは Flash Player の ```NetStream``` オブジェクトの ```seek()``` メソッドで記述した時間の前後の最も近いキーフレームに進みます（詳細については Adobe のドキュメントを参照してください）。<br><br>
> * ```allowSeekAhead``` パラメータは、```seconds``` の値が現在バッファ済みの動画データの範囲内にない場合、プレーヤーからサーバーに新しいリクエストを行うかどうかを指定します。<br><br>
>   * このパラメータは、ユーザーがマウスで動画の進行バーをドラッグしている間は ```false```、マウスを放したら ```true``` に設定することをお勧めします。このように設定するとユーザーは、動画内の過去にバッファされていない場面をスクロールすることで、動画ストリームを新たにリクエストせずに、動画内の別の場面にスクロールできます。ユーザーがマウスボタンを放すと、プレーヤーは動画内の目的の画面に進み、必要に応じて新しい動画ストリームをリクエストします。
<br><br>

### 現在の動画開始からの時間を取得: ```player.getCurrentTime()```
現在の動画開始後の秒数を小数で返す。<br><br>


## 2. 字幕の取得: ```caption.list[index: Integer]```
```caption.list``` は、動画の字幕情報を格納した配列。動画を検索し、字幕情報を取得できた時点で利用可能となる。(```onCaptionLoad()```内では利用可。) 字幕取得が完了するまで、もしくは字幕が取得できなかった場合は ```null``` となっているので注意。

配列なので、```caption.list.length``` で字幕トラックの総数を取得できる。

```index```　= 0, 1, 2, 3。時間順に字幕情報を格納。<br> <br>

### 時間 (文字列): ```caption.list[i].time```
$i$ $(= 0, 1, 2 \cdots)$ 番目の字幕トラックの開始時間。"(時間) : (分) : (秒)" の形式の文字列。(時間) が0のときは、"(分) : (秒)" の形式で、(秒) だけは常に2桁になるように0埋めされる。<br><br>

### 時間 (小数): ```caption.list[i].time_float```
$i$番目の字幕トラックの開始時間。単位は秒。小数。<br><br>

### 持続時間 (小数): ```caption.list[i].dur_float```
$i$番目の字幕トラックが表示されてから消えるまでかかる秒数。小数。<br><br>

### 字幕の内容 (文字列): ```caption.list[i].caption```
$i$番目の字幕トラックの内容。<br><br>


## 3. エラー処理
検索時に何らかの理由で動画や字幕が取得できなかった場合は、 ```./main/scripts/front.js``` 内の ```onCaptionReady``` 関数が実行されるので、エラー処理は、この関数内に記述する。<br><br>

### エラーメッセージ: ```error.message```
エラーが発生すると、この変数にエラーメッセージの文字列が格納される。<br><br>

### エラー元: ```error.src```
```"search"```: 検索キーワードが正しくない場合

```"player"```: 動画プレイヤーに関するエラー (動画が埋め込みを許可していないなど)

```"caption"```: 字幕取得に関するエラー (字幕が英語に対応していないなど)
<br><br>

### エラーの詳細: ```error.detail```
httpエラーステータスやスクリプトのエラー内容は、文字列としてこの変数に格納される。